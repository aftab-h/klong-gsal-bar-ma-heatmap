<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmap</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            justify-content: space-around;
            margin: 20px;
        }

        .text-container {
            position: relative;
            width: 45%;
            max-height: 90vh; /* Maximum height of container, adjust as needed */
            overflow-y: auto; /* Add scrollbar for vertical overflow */
            border: 1px solid #ccc;
            padding: 10px;
        }

        .highlight {
            background-color: yellow;
        }

        .highlight-marker {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.5); /* Semi-transparent yellow */
            width: 5px; /* Width of the marker */
            pointer-events: none; /* Ignore mouse events on markers */
        }

        .highlight-ls {
            background-color: yellow; /* Example color for LS Corpus highlights */
        }

        .highlight-t {
            background-color: lightgreen; /* Example color for T Text highlights */
        }

        /* WebKit-specific scrollbar style */
        .text-container::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        /* WebKit-specific scrollbar thumb style */
        .text-container::-webkit-scrollbar-thumb {
            background-color: darkgray; /* Thumb color */
            border-radius: 4px; /* Roundness of the thumb */
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="text-container" id="tantra-of-the-sun">
            <h2>Tantra of the Sun (T)</h2>
            <div id="t-text">Paste the text of T here</div>
            <div class="highlight-marker" id="t-highlight-marker"></div>
        </div>
        <div class="text-container" id="ls-corpus">
            <h2>LS Corpus</h2>
            <div id="ls-text">Paste the text of LS Corpus here</div>
            <div class="highlight-marker" id="ls-highlight-marker"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const lsCorpusContainer = document.getElementById('ls-text');
            const tTextContainer = document.getElementById('t-text');

            // Load LS Corpus and T Text CSV files and process the data
            Promise.all([
                fetchAndLoadCSV('ls-corpus-test.csv', lsCorpusContainer),
                fetchAndLoadCSV('t-text-test.csv', tTextContainer)
            ]).then(() => {
                // Now that text is loaded, load key.csv and process the data
                fetch('key.csv')
                    .then(response => response.text())
                    .then(csvData => {
                        const keyData = parseCSV(csvData);

                        // Iterate through each row of the key data
                        keyData.forEach(row => {
                            const lsCorpusCitation = row['Quote in LS'];
                            const tTextCitation = row['Quote in T Text'];

                            // Highlight LS Corpus citation
                            highlightCitation(lsCorpusContainer, lsCorpusCitation, 'highlight-ls');

                            // Highlight T Text citation
                            highlightCitation(tTextContainer, tTextCitation, 'highlight-t');
                        });

                        // Add event listener for LS Corpus citations
                        lsCorpusContainer.addEventListener('click', function(event) {
                            const clickedElement = event.target;
                            if (clickedElement.classList.contains('highlight-ls')) {
                                // Retrieve the associated UID
                                const uid = clickedElement.getAttribute('data-uid');
                                // Find the corresponding T Text citation
                                const tTextCitation = document.querySelector(`[data-uid="${uid}"]`);
                                // Scroll to the T Text citation
                                if (tTextCitation) {
                                    tTextCitation.scrollIntoView({ behavior: 'smooth' });
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error loading or processing key.csv:', error));
            }).catch(error => console.error('Error loading or processing CSVs:', error));
        });

        // Function to fetch and load CSV data into a container
        function fetchAndLoadCSV(csvPath, container) {
            return fetch(csvPath)
                .then(response => response.text())
                .then(csvData => {
                    // Set the inner HTML of the container with the CSV data
                    container.innerHTML = csvData;
                });
        }

        // Function to highlight citations in a container
        function highlightCitation(container, citation, highlightClass) {
            if (!container || !citation) return;

            // Properly escape the citation for regex use
            const escapedCitation = citation.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const regex = new RegExp(`(${escapedCitation})`, 'g');

            // Replace the matched citation text with highlighted version
            container.innerHTML = container.innerHTML.replace(regex, (match, p1) => {
                // Generate a random UID for each citation
                const uid = Math.floor(Math.random() * 10000);
                return `<span class="${highlightClass}" data-uid="${uid}">${p1}</span>`;
            });
        }

        // Simple CSV parser function
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const headers = lines.shift().split(',');
            return lines.map(line => {
                const data = line.split(',');
                return headers.reduce((obj, nextKey, index) => {
                    obj[nextKey] = data[index];
                    return obj;
                }, {});
            });
        }
    </script>
</body>
</html>
